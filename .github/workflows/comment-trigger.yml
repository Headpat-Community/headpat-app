name: Build App on PR Comments

on:
  issue_comment:
    types:
      - created

permissions:
  issues: write  # To update comments
  pull-requests: read
  contents: read

jobs:
  build:
    if: |
      github.event.issue.pull_request && 
      (github.event.comment.body == 'build:android' || github.event.comment.body == 'build:ios')
    runs-on: ${{ github.event.comment.body == 'build:android' && 'ubuntu-latest' || 'macos-latest' }}
    strategy:
      matrix:
        node: [22.x]

    steps:
      - name: Check comment author permissions
        id: check-permissions
        run: |
          PERMISSION=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/collaborators/${{ github.event.comment.user.login }}/permission \
            --jq '.permission')
          echo "User permission: $PERMISSION"
          if [[ "$PERMISSION" != "admin" && "$PERMISSION" != "maintain" && "$PERMISSION" != "write" ]]; then
            echo "User ${{ github.event.comment.user.login }} does not have sufficient permissions to trigger the build."
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 💬 Post initial status comment
        id: comment
        run: |
          echo "::set-output name=comment_id::$(gh api \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/comments" \
            -f body='Building app for ${{ github.event.comment.body == "build:android" && "android" || "ios" }}... This can take about 25 minutes.' \
            --jq '.id')"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 🏗 Setup repo
        uses: actions/checkout@v2

      - name: 🏗 Setup Node
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - name: 🏗 Setup Java
        if: ${{ github.event.comment.body == 'build:android' }}
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: 🏗 Setup Expo and EAS
        uses: expo/expo-github-action@v7
        with:
          token: ${{ secrets.EXPO_TOKEN }}
          expo-version: latest
          eas-version: latest

      - name: 📦 Install dependencies
        run: npm install

      - name: 👷 Build app
        run: |
          eas build --local \
            --non-interactive \
            --output=./app-build \
            --platform=${{ github.event.comment.body == 'build:android' && 'android' || 'ios' }} \
            --profile=production

      - name: 🚢 Submit
        run: |
          eas submit -p ${{ github.event.comment.body == 'build:android' && 'android' || 'ios' }} --profile=production --path app-build

      - name: 💬 Update comment to success
        if: success()
        run: |
          gh api \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/comments/${{ steps.comment.outputs.comment_id }}" \
            -f body='Build complete for ${{ github.event.comment.body == "build:android" && "android" || "ios" }}.'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 💬 Update comment to failure
        if: failure()
        run: |
          gh api \
            -X PATCH \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/issues/comments/${{ steps.comment.outputs.comment_id }}" \
            -f body='Build failed for ${{ github.event.comment.body == "build:android" && "android" || "ios" }}.'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
